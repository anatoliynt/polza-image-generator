"""
–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π Polza.AI
–¶–µ–ª—å: –ø–æ–∫–∞–∑–∞—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–∞–º, –∫–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è —Å–æ–∑–¥–∞–Ω–Ω—ã–º –º–æ–¥—É–ª–µ–º
–ó–ê–©–ò–¢–ê: –î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ö–∞–Ω–∏–∑–º –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Å–ª—É—á–∞–π–Ω—ã—Ö –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö —Ç—Ä–∞—Ç
"""

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –º–æ–¥—É–ª–∏
import sys  # –î–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø—É—Ç—è–º–∏ –∫ –º–æ–¥—É–ª—è–º
import os  # –î–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–æ–π
import json # –î–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
import datetime # –î–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∞—Ç–æ–π

# –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Ç—å –∫ –ø–∞–ø–∫–µ src, —á—Ç–æ–±—ã Python –º–æ–≥ –Ω–∞–π—Ç–∏ –Ω–∞—à –º–æ–¥—É–ª—å
sys.path.insert(0, os.path.join(os.path.dirname(__file__), '..'))

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–∞—à –∫–ª–∞—Å—Å –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
from src.image_generator import PolzaImageGenerator


def save_last_task(task_id):
    """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç ID –ø–æ—Å–ª–µ–¥–Ω–µ–π –∑–∞–¥–∞—á–∏, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –∫ –Ω–µ–π –≤–µ—Ä–Ω—É—Ç—å—Å—è"""
    with open('last_task.json', 'w') as f:
        json.dump({
            'task_id': task_id,
            'timestamp': datetime.datetime.now().isoformat()
        }, f)

def load_last_task():
    """–ó–∞–≥—Ä—É–∂–∞–µ—Ç ID –ø–æ—Å–ª–µ–¥–Ω–µ–π –∑–∞–¥–∞—á–∏"""
    if os.path.exists('last_task.json'):
        try:
            with open('last_task.json', 'r') as f:
                return json.load(f)
        except:
            return None
    return None

def main():
    """
    –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è - –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    
    –¶–µ–ª—å: –ø–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —ç—Ç–∞–ø—ã —Ä–∞–±–æ—Ç—ã —Å API –æ—Ç –∑–∞–ø—Ä–æ—Å–∞ –¥–æ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
    –ó–∞–¥–∞—á–∏:
    1. –°–æ–∑–¥–∞—Ç—å —ç–∫–∑–µ–º–ø–ª—è—Ä –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞
    2. –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é
    3. –î–æ–∂–¥–∞—Ç—å—Å—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
    4. –°–∫–∞—á–∞—Ç—å –≥–æ—Ç–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    """
    
    # –í—ã–≤–æ–¥–∏–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –ø—Ä–æ–≥—Ä–∞–º–º—ã
    print("=" * 60)
    print("üé® –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π Polza.AI - –£—á–µ–±–Ω—ã–π –ø—Ä–∏–º–µ—Ä")
    print("=" * 60)
    print()
    
    try:
        # –®–∞–≥ 1: –°–æ–∑–¥–∞—ë–º —ç–∫–∑–µ–º–ø–ª—è—Ä –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ (API –∫–ª—é—á –±–µ—Ä—ë—Ç—Å—è –∏–∑ .env)
        print("üìå –®–∞–≥ 1: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞")
        generator = PolzaImageGenerator()
        print("‚úÖ –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω\n")
        
        # =================================================================================
        # üõ°Ô∏è –ó–ê–©–ò–¢–ê –û–¢ –§–ò–ù–ê–ù–°–û–í–´–• –ü–û–¢–ï–†–¨
        # =================================================================================
        last_task = load_last_task()
        task_id = None
        
        if last_task:
            print(f"‚ö†Ô∏è –ù–∞–π–¥–µ–Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–∞—è –∑–∞–¥–∞—á–∞: {last_task.get('task_id')}")
            print(f"üïí –°–æ–∑–¥–∞–Ω–∞: {last_task.get('timestamp')}")
            user_choice = input("–•–æ—Ç–∏—Ç–µ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –æ–∂–∏–¥–∞–Ω–∏–µ —ç—Ç–æ–π –∑–∞–¥–∞—á–∏ –≤–º–µ—Å—Ç–æ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–π? (y/n): ").lower()
            
            if user_choice == 'y':
                task_id = last_task.get('task_id')
                print(f"‚ôªÔ∏è –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–¥–∞—á—É ID: {task_id}")
            else:
                print("üí∞ –ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–∞ –ù–û–í–ê–Ø –∑–∞–¥–∞—á–∞ (—Å–ø–∏—Å–∞–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤!)")
        
        # –ï—Å–ª–∏ –∑–∞–¥–∞—á—É –Ω–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–ª–∏, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é
        if not task_id:
            # –®–∞–≥ 2: –ó–∞–¥–∞—ë–º –ø—Ä–æ–º–ø—Ç - –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≥–æ, —á—Ç–æ —Ö–æ—Ç–∏–º –Ω–∞—Ä–∏—Å–æ–≤–∞—Ç—å
            print("üìå –®–∞–≥ 2: –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏")
            
            prompt = "Festive New Year community gathering illustration, neighbors celebrating together in apartment building courtyard, ice skating rink with bublik tubes, warm lights, Christmas decorations, friendly atmosphere, cozy winter evening, digital art, vibrant colors, detailed, heartwarming scene"
            print(f"–ü—Ä–æ–º–ø—Ç: {prompt}\n")
            
            # ‚ö†Ô∏è –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ï –ü–ï–†–ï–î –°–ü–ò–°–ê–ù–ò–ï–ú
            confirm = input("–í—ã –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç–µ —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (—Å–ø–∏—Å–∞–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤)? (y/n): ")
            if confirm.lower() != 'y':
                print("‚ùå –û—Ç–º–µ–Ω–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.")
                return

            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é
            result = generator.generate_image(
                prompt=prompt,
                model="gemini-3-pro-image-preview", # –ï—Å–ª–∏ –∑–∞–≤–∏—Å–∞–µ—Ç - –ø–æ–ø—Ä–æ–±—É–π—Ç–µ "flux-pro-1.1"
                width=1024,
                height=1024
            )
            
            # –ò–∑–≤–ª–µ–∫–∞–µ–º ID –∑–∞–¥–∞—á–∏
            task_id = result.get('requestId') or result.get('id') or result.get('task_id')
            print(f"ID –∑–∞–¥–∞—á–∏: {task_id}\n")
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –∑–∞–¥–∞—á–∏
            if task_id:
                save_last_task(task_id)
        
        # –ï—Å–ª–∏ ID –Ω–µ –Ω–∞–π–¥–µ–Ω - –ø—Ä–µ–∫—Ä–∞—â–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
        if not task_id:
            print("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å ID –∑–∞–¥–∞—á–∏ –∏–∑ –æ—Ç–≤–µ—Ç–∞ API")
            return
        
        # –®–∞–≥ 3: –û–∂–∏–¥–∞–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (–¢–∞–π–º–∞—É—Ç —É–≤–µ–ª–∏—á–µ–Ω –¥–æ 10 –º–∏–Ω—É—Ç)
        print("üìå –®–∞–≥ 3: –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (–¥–æ 10 –º–∏–Ω)")
        final_result = generator.wait_for_image(
            task_id=task_id,
            max_wait=600,  # 600 —Å–µ–∫—É–Ω–¥ = 10 –º–∏–Ω—É—Ç
            check_interval=5
        )
        print()
        
        # –®–∞–≥ 4: –ò–∑–≤–ª–µ–∫–∞–µ–º URL –≥–æ—Ç–æ–≤–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑ –æ—Ç–≤–µ—Ç–∞
        print("üìå –®–∞–≥ 4: –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è")
        print(f"üîç –§–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç API: {final_result}")
        
        image_url = None
        
        # –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: –ü–æ–ª–µ output (–∫–∞–∫ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏)
        if 'output' in final_result:
            output = final_result.get('output')
            if isinstance(output, list) and len(output) > 0:
                image_url = output[0]
            elif isinstance(output, str):
                image_url = output
        
        # –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: –ü–æ–ª–µ data (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç)
        elif 'data' in final_result and isinstance(final_result['data'], list) and len(final_result['data']) > 0:
            item = final_result['data'][0]
            image_url = item.get('url') or item.get('image_url')
            
        # –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3: URL –ø—Ä—è–º–æ –≤ –∫–æ—Ä–Ω–µ
        elif 'url' in final_result:
            image_url = final_result.get('url')
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ URL –Ω–∞–π–¥–µ–Ω
        if not image_url:
            print("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –æ—Ç–≤–µ—Ç–µ API")
            return
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –ø—É—Ç—å –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: output/generated_<task_id>.png
        safe_task_id = str(task_id).replace(':', '_').replace('/', '_')
        save_path = os.path.join('output', f'generated_{safe_task_id}.png')
        
        # –°–∫–∞—á–∏–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        saved_file = generator.download_image(image_url, save_path)
        print()
        
        # –í—ã–≤–æ–¥–∏–º –∏—Ç–æ–≥–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
        print("=" * 60)
        print("‚úÖ –£—Å–ø–µ—Ö! –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ")
        print(f"üìÅ –§–∞–π–ª: {saved_file}")
        print("=" * 60)
        
        # –ï—Å–ª–∏ –≤—Å—ë —É—Å–ø–µ—à–Ω–æ - —É–¥–∞–ª—è–µ–º –∑–∞–ø–∏—Å—å –æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –∑–∞–¥–∞—á–µ
        if os.path.exists('last_task.json'):
            os.remove('last_task.json')
        
    except ValueError as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: {e}")
        print("üí° –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–∞–π–ª .env - —Ç–∞–º –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤–∞—à API –∫–ª—é—á")
        
    except TimeoutError as e:
        print(f"‚ùå –ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è: {e}")
        print("üí° –ó–∞–¥–∞—á–∞ –≤—Å–µ –µ—â–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.")
        print("üí° –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç —Å–Ω–æ–≤–∞ –∏ –≤—ã–±–µ—Ä–∏—Ç–µ 'y' –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –æ–∂–∏–¥–∞–Ω–∏—è —ç—Ç–æ–π –∂–µ –∑–∞–¥–∞—á–∏.")
        
    except Exception as e:
        print(f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {e}")
        print("üí° –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É –∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å API –∫–ª—é—á–∞")


# –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –≤ –ø—Ä–æ–≥—Ä–∞–º–º—É
if __name__ == "__main__":
    main()
